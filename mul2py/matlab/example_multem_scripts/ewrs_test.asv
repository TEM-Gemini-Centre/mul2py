%%
start_time = datetime('now','TimeZone','local','Format','HH:mm:ss');
fprintf("Starting simulation script at %s", start_time);
%%
simulation_name = "EWRS_test";
%% Configure simulation devices
system_conf.precision = 1;                           % eP_Float = 1, eP_double = 2
system_conf.device = 1;                              % eD_CPU = 1, eD_GPU = 2
system_conf.cpu_nthread = 4;                         % Number of tasks (?)
%% Load simulation parameters. `MULTEM_input.mat` should contain a struct called `input_multislice` with all relevant simulation parameters given in its fields, including the atomistic model.
input_multislice = EWRS_setup("test_model_L_10x10x20.mat", 15, "nx", 16, "ny", 32, "instrument", "2100F", "multem_path", "C:\Program Files\MULTEM\MULTEM_binary");
original_input = input_multislice;
%% Set up scan pattern
%Scan one unit cell centered in the middle of the cell with 1/4 unit cell resolution

centre_x = original_input.spec_lx/2;
centre_y = original_input.spec_ly/2;

scanning_width = original_input.spec_cryst_a;
scanning_height = original_input.spec_cryst_b;

scanning_ns_x = 2;
scanning_ns_y = 3;

x0 = centre_x - scanning_width/2;
y0 = centre_y - scanning_height/2;

xe = x0 + scanning_width;
ye = x0 + scanning_height;


xs = linspace(x0, xe, scanning_ns_x);
ys = linspace(y0, ye, scanning_ns_y);

%% Loop through x and y positions
results.input = original_input;
results.xs = xs;
results.ys = ys;
results.images = zeros(input_multislice.nx, input_multislice.ny, size(xs, 2), size(ys, 2), size(input_multislice.thick, 2));
results.thicknesses = {};
counter = 1;
for i = 1:size(results.xs, 2)
    x = xs(i);
    for j = 1:size(results.ys, 2)
        y = ys(j);
        %shift beam
        input_multislice = original_input;
        input_multislice.iw_x = x;
        input_multislice.iw_y = y;
        
        file_name = sprintf("%s_%i_%i", i, j); %Name for storing individual output file if an exception is thrown.
        %Run simulation
        fprintf("Simulating EWRS stack %i of %i: (x,y) = (%f,%f)\r", counter, length(xs) * length(ys), input_multislice.iw_x, input_multislice.iw_y);
        clear il_MULTEM;
        tic;
        output_multislice = il_MULTEM(system_conf, input_multislice); 
        toc;
        results.thicknesses{i, j} = output_multislice.thick;
        try
            for t = 1:length(output_multislice.data)
                results.images(:, :, i, j, t) = transpose(output_multislice.data(t).m2psi_tot);
            end
        catch ME
            fprintf("Exception for i=%i, j=%i, and t=%i. Data size: (%s)", i, j, t, strip(sprintf("%i,", size(output_multislice.data)), "right", ","));
            save("ewrs_test_output.mat", "output_multislice", "-v7.3");
            save("ewrs_test_results.mat", "results", "-v7.3");
            rethrow(ME)
        end        
        counter=counter+1;
    end
end
%%
results.thick = output_multislice.thick;
results.dx = output_multislice.dx;
results.dy = output_multislice.dy;

end_time = datetime('now','TimeZone','local','Format','HH:mm:ss');
fprintf("Simulation finished at %s", end_time);
results.elapsed_time = sprintf("%s", end_time - start_time);
save("ewrs_test_results.ecmat", "results", "-v7.3");